<!DOCTYPE html>
<html>

	<head>
		
		<title>Geo Example</title>
		
		<style>
			
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			
			#map {
				height: 100%;
			}
			
		</style>
		
	</head>

	<body>

		<div id="map"></div>
		
		<script>
			
			var urlParams = new URLSearchParams(window.location.search);
			var env = urlParams.get('env');
			var exptid = urlParams.get('exptid');
			var JSElement = document.createElement('script');
			JSElement.src = "https://maps.googleapis.com/maps/api/js?key=" + urlParams.get('token');
			JSElement.defer = true;
			JSElement.onload = initMap;
			document.getElementsByTagName('head')[0].appendChild(JSElement);
			
			function readTextFile(file, callback, opt) {
				var rawFile = new XMLHttpRequest();
				rawFile.overrideMimeType("application/json");
				rawFile.open("GET", file, true);
				rawFile.onreadystatechange = function() {
					if (rawFile.readyState === 4 && rawFile.status == "200") {
						callback(rawFile.responseText, opt);
					}
				}
				rawFile.send(null);
			}
			
			function initMap() {
				
				var map = new google.maps.Map(document.getElementById('map'), {
					zoom: 4,
					center: {lng: -98.5556199, lat: 39.8097343},
					mapTypeId: 'roadmap',
					styles: [
					  {
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#f5f5f5"
					      }
					    ]
					  },
					  {
					    "elementType": "labels.icon",
					    "stylers": [
					      {
						"visibility": "off"
					      }
					    ]
					  },
					  {
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#616161"
					      }
					    ]
					  },
					  {
					    "elementType": "labels.text.stroke",
					    "stylers": [
					      {
						"color": "#f5f5f5"
					      }
					    ]
					  },
					  {
					    "featureType": "administrative.land_parcel",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#bdbdbd"
					      }
					    ]
					  },
					  {
					    "featureType": "poi",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#eeeeee"
					      }
					    ]
					  },
					  {
					    "featureType": "poi",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#757575"
					      }
					    ]
					  },
					  {
					    "featureType": "poi.park",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#e5e5e5"
					      }
					    ]
					  },
					  {
					    "featureType": "poi.park",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#9e9e9e"
					      }
					    ]
					  },
					  {
					    "featureType": "road",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#ffffff"
					      }
					    ]
					  },
					  {
					    "featureType": "road.arterial",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#757575"
					      }
					    ]
					  },
					  {
					    "featureType": "road.highway",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#dadada"
					      }
					    ]
					  },
					  {
					    "featureType": "road.highway",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#616161"
					      }
					    ]
					  },
					  {
					    "featureType": "road.local",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#9e9e9e"
					      }
					    ]
					  },
					  {
					    "featureType": "transit.line",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#e5e5e5"
					      }
					    ]
					  },
					  {
					    "featureType": "transit.station",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#eeeeee"
					      }
					    ]
					  },
					  {
					    "featureType": "water",
					    "elementType": "geometry",
					    "stylers": [
					      {
						"color": "#c9c9c9"
					      }
					    ]
					  },
					  {
					    "featureType": "water",
					    "elementType": "labels.text.fill",
					    "stylers": [
					      {
						"color": "#9e9e9e"
					      }
					    ]
					  }
					]
				});
				
				infoWindow = new google.maps.InfoWindow;
				
				if (env == 'p1') {
					var clientPrefix = 'build_';
					if (exptid == 80) {
						var locationType = 'US_DMA';
						var locations = [
							[38015,37917,37851,37886,38005,37830,37984,37936,37909,37934,37947,37911,37959,38006,37874,38025,37933,37930,37980,37857,37861,37832,37883,37888,38007,37895,37946,37844,37820,37847],
							[37860,37826,37975,37915,37999,37937,38017,38027,37941,37872,37877,37887,37858,37838,37884,37868,37890,37829,37927,37969,37913,37950,38009,37928,37919,37856,37849,38018,37852,37853],
							[37850,37848,37891,37881,37963,38003,37865,37926,37923,37896,38016,37842,37922,38028,37974,37914,37862,37932,37901,37968,38000,37837,37964,37965,37944,37956,38029,37905,37839,37855]
						];
					} else if (exptid == 67) {
						var locationType = 'US_CBSA';
						var locations = [
							[433,685,741,603,665,369,689,355,112,377,97,352,166,662,260,276,738,834,362,375,478,199,722,751,374,113,34,806,686,752,364,594,781,57,343,426,930,182,598,593,790,542,76,274,286,3,446,490,602,162,212,293,697,60,753,617,692,750,619,585,69,537,493,794,158,763,265,64,818,306,837,844,643,477,496,812,696,230,96,23,348,559,935,302,912,853,226,310,708,335,928,451,186,723,415,365,900,470,816,459,220,292,825,133,936,473,468,398,482,54],
							[555,416,601,543,163,934,207,566,295,299,406,146,672,143,409,560,673,148,464,693,246,591,799,218,405,924,761,589,791,558,773,613,910,666,382,89,540,762,273,718,381,443,394,434,121,563,307,128,621,408,48,139,47,736,716,59,11,125,2,445,160,800,357,911,164,622,39,777,663,810,15,861,378,453,399,628,883,510,251,179,852,571,856,123,605,263,329,32,318,393,20,500,80,269,444,742,154,231,250,244,486,94,721,754,170,440,49,290,156,634],
							[116,811,392,140,775,704,713,730,454,430,25,141,644,108,82,604,569,573,501,87,859,118,869,652,70,461,700,519,505,159,155,766,483,105,95,814,402,456,439,629,739,282,131,805,552,854,886,620,462,567,757,565,706,228,838,860,442,626,507,198,337,850,898,319,106,564,7,707,74,888,183,10,749,517,342,465,173,765,92,90,110,187,241,819,768,323,350,783,467,217,345,650,317,792,746,400,917,687,740,455,249,813,358,324,370,884,191,184,702,410]
						];
					}
				} else if (env == 'p2') {
					var clientPrefix = 'ctc_';
					if (exptid == 48) {
						var locationType = 'CA_CITY';
						var locations = [
							[94,98,56,352,262,282,179,177,280,240,311,272,325,72,322,344,207,252,260,211,59,64,76,190,130,283,112,125,181,183,26,97,203,126,34,65,210,234,7,17,73,79,223,327,251,221,205,8,321,225,165,99,156,178,20,43,213,135,60,288,122,140,95,239,319,315,245,270,121,175,35,102,338,347,310,63,265,23,296,16,151,171,66,117,75,329,131,289,74,220,27,37,57,145,194,336,115,254,230,244,3,172,302,219,313,247],
							[85,39,52,348,255,301,243,229,267,297,343,286,345,118,309,349,164,320,246,206,86,32,92,189,166,341,136,157,163,174,19,84,159,100,50,41,281,263,11,12,104,137,217,337,201,257,222,5,237,291,108,62,162,236,18,29,184,142,77,269,141,195,80,261,318,290,227,241,148,176,24,111,279,323,335,48,264,28,303,14,202,158,51,116,53,339,155,284,81,212,47,55,124,101,198,334,91,218,258,199,6,147,294,242,266,170],
							[67,46,69,351,233,307,295,197,324,253,350,287,330,105,317,346,182,304,276,209,40,38,96,187,169,292,103,153,90,196,31,134,109,120,49,45,271,226,9,10,61,68,268,342,146,285,275,2,224,250,185,71,152,133,22,30,193,143,58,277,78,107,93,204,316,340,274,129,113,228,36,114,306,354,326,82,259,42,299,15,248,127,88,119,54,328,168,180,106,215,33,44,149,154,186,332,167,214,273,138,4,161,249,231,312,188]
						];
					}
				} else {
					console.error("unknown env: " + env);
				}
				
				if (locationType == 'US_DMA') {
					readTextFile('locationMapping/' + clientPrefix + "usDmaLocationOsmMapping.json", function(text) {
						createDMAShapes(JSON.parse(text), locations, map);
					});
				} else if (locationType == 'US_CBSA') {
					readTextFile('locationMapping/' + clientPrefix + "usCbsaLocationOsmMapping.json", function(text) {
						createUsCbsaShapes(JSON.parse(text), locations, map);
					});
				} else if (locationType == 'US_COUNTY') {
					readTextFile('locationMapping/' + clientPrefix + "usCountyLocationOsmMapping.json", function(text) {
						createUSCountyShapes(JSON.parse(text), locations, map);
					});
				} else if (locationType == 'CA_CITY') {
					readTextFile('locationMapping/' + clientPrefix + "caCityLocationOsmMapping.json", function(text) {
						createCACityShapes(JSON.parse(text), locations, map);
					});
				} else {
					console.error("unknown locationType: " + locationType);
				}

				addColorToShapes(map);
				
				map.data.addListener('click', function(event) {
					console.log(event);
        				infoWindow.setContent(event.feature.getProperty('id').toString());
					infoWindow.setPosition(event.latLng);
					infoWindow.open(map);
// 					document.getElementById('info-box').textContent = event.feature.getProperty('letter');
				});
				
			}

			function createDMAShapes(mapping, locations, map) {
				for (var cellNum = 0; cellNum < locations.length; cellNum++) {
					for (var location of locations[cellNum]) {
						if (location in mapping) {
							readTextFile("geoJsonData/usDmaGeoJsonData/" + mapping[location] + ".txt", function(geoJsonText, opt) {
								geoJsonData = JSON.parse(geoJsonText);
								geoJsonData.properties = {"cellNum": opt.cellNum, "id": opt.location};
								map.data.addGeoJson(geoJsonData);
							}, {"cellNum": cellNum, "id": location});
						} else {
							console.log('location ' + location + ' not found.');
						}
					}
				}
			}

			function createUsCbsaShapes(mapping, locations, map) {
				for (var cellNum = 0; cellNum < locations.length; cellNum++) {
					for (var location of locations[cellNum]) {
						if (location in mapping) {
							readTextFile("geoJsonData/usCbsaGeoJsonData/" + mapping[location] + ".txt", function(geoJsonText, opt) {
								geoJsonData = JSON.parse(geoJsonText);
								geoJsonData.properties = {"cellNum": opt.cellNum, "id": opt.location};
								map.data.addGeoJson(geoJsonData);
							}, {"cellNum": cellNum, "id": location});
						} else {
							console.log('location ' + location + ' not found.');
						}
					}
				}
			}

			function createUSCountyShapes(mapping, locations, map) {
				for (var cellNum = 0; cellNum < locations.length; cellNum++) {
					for (var location of locations[cellNum]) {
						if (location in mapping) {
							readTextFile("geoJsonData/usCountyGeoJsonData/" + mapping[location] + ".txt", function(geoJsonText, opt) {
								formatGeoJson(JSON.parse(geoJsonText), opt.cellNum, map, opt.id);
							}, {"cellNum": cellNum, "id": location});
						} else {
							console.log('location ' + location + ' not found.');
						}
					}
				}
			}

			function createCACityShapes(mapping, locations, map) {
				for (var cellNum = 0; cellNum < locations.length; cellNum++) {
					for (var location of locations[cellNum]) {
						if (location in mapping && mapping[location] != 0) {
							readTextFile("geoJsonData/caCityGeoJsonData/" + mapping[location] + ".txt", function(geoJsonText, opt) {
								formatGeoJson(JSON.parse(geoJsonText), opt.cellNum, map, opt.id);
							}, {"cellNum": cellNum, "id": location});
						} else {
							console.log('location ' + location + ' not found.');
						}
					}
				}
			}

			function formatGeoJson(geoJsonData, cellNum, map, location) {
				for (var i = 0; i < geoJsonData.geometries.length; i++) {
					var newGeoJsonData = JSON.parse(JSON.stringify(geoJsonData));
					newGeoJsonData.type = 'Feature';
					newGeoJsonData.geometry = geoJsonData.geometries[i];
					delete newGeoJsonData.geometries;
					newGeoJsonData.properties = {"cellNum": cellNum, "geometryCount": i, "id": location};
					map.data.addGeoJson(newGeoJsonData);
				}
			}

			function addColorToShapes(map) {
				map.data.setStyle(function(feature) {
					var cellNum = feature.getProperty('cellNum');
					var colors = ['red', 'blue', 'green'];
					if (cellNum < colors.length) {
						return {
							fillColor: colors[cellNum],
							strokeWeight: 0.5
						}
					} else {
						return {
							fillColor: 'gray',
							strokeWeight: 1
						}
					}
				});
			}
			
		</script>
		
	</body>

</html>
