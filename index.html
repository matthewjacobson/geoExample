<!DOCTYPE html>
<html>

	<head>
		
		<title>Geo Example</title>
		
		<style>
			
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			
			#map {
				height: 100%;
			}
			
		</style>
		
	</head>

	<body>

		<div id="map"></div>
		
		<script>
			
			var urlParams = new URLSearchParams(window.location.search);
			var JSElement = document.createElement('script');
			JSElement.src = "https://maps.googleapis.com/maps/api/js?key=" + urlParams.get('token');// + "&callback=initMap";
			JSElement.defer = true;
			JSElement.onload = initMap;
			document.getElementsByTagName('head')[0].appendChild(JSElement);
			
			function readTextFile(file, callback) {
				var rawFile = new XMLHttpRequest();
				rawFile.overrideMimeType("application/json");
				rawFile.open("GET", file, true);
				rawFile.onreadystatechange = function() {
					if (rawFile.readyState === 4 && rawFile.status == "200") {
						callback(rawFile.responseText);
					}
				}
				rawFile.send(null);
			}
			
			function initMap() {
				
				var map = new google.maps.Map(document.getElementById('map'), {
					zoom: 4,
					center: {lng: -98.5556199, lat: 39.8097343},
					mapTypeId: 'terrain'
				});
				
// 				var locationType = 'DMA';
// 				var locations = [
// 					[662, 790, 634, 635, 537, 821, 502, 757, 514, 767, 519, 584, 602, 598, 546, 535, 623, 751, 606, 565, 802, 513, 670, 798, 755, 545, 636, 533, 618, 527, 561, 603, 702, 643, 839, 722, 529, 669, 813, 528, 687, 628, 570, 501, 633, 534, 804, 675, 508, 552, 560, 556, 611, 576, 641, 855, 657, 725, 619, 609, 539, 605, 789, 709, 625, 705, 627, 550, 771],	// cell 1
// 					[525, 644, 524, 800, 716, 756, 630, 506, 523, 637, 564, 575, 868, 510, 604, 673, 682, 679, 676, 516, 649, 866, 509, 773, 658, 567, 566, 710, 691, 718, 574, 616, 582, 551, 541, 693, 651, 737, 640, 617, 762, 828, 659, 544, 650, 631, 656, 504, 820, 521, 764, 573, 610, 770, 825, 507, 612, 588, 543, 555, 581, 540, 671, 526, 511, 548, 678, 810, 596],	// cell 2
// 					[532, 583, 520, 512, 692, 746, 559, 736, 754, 648, 517, 759, 515, 752, 522, 600, 542, 505, 765, 801, 724, 571, 592, 563, 518, 647, 569, 766, 758, 639, 734, 557, 642, 749, 558, 803, 503, 553, 711, 613, 686, 698, 622, 740, 652, 632, 597, 753, 500, 717, 811, 538, 862, 661, 807, 819, 624, 881, 638, 530, 547, 531, 760, 626, 549, 554, 577, 536]		// cell 3
// 				];
				
				var locationType = 'COUNTY';
				var locations = [
					[943, 951, 959],	// cell 1
					[967, 975, 983],	// cell 2
					[991, 999, 1007, 1015]	// cell 3
				];
				
				
				if (locationType == 'DMA') {

					readTextFile("dmaData.json", function(text){
						var dmaData = JSON.parse(text);
						for (var locationList of locations) {
							for (var location of locationList) {
								var geoData = dmaData.features.filter(function(data) { 
									return data.properties.dma == location 
								});
								if (geoData.length == 1) {
									map.data.addGeoJson(geoData[0]);
								} else if (geoData.length == 0) {
									console.log('no dmas found for ' + location);
								} else {
									console.log('multiple dmas found for ' + location);
								}

							}
						}
					});

					map.data.setStyle(function(feature) {
						var dma = feature.getProperty('dma');
						var colors = ['red', 'blue', 'green'];
						for (var i = 0; i < locations.length; i++) {
							if (locations[i].includes(dma)) {
								return {
									fillColor: colors[i],
									strokeWeight: 1
								}
							}
						}
						return {
							fillColor: 'gray',
							strokeWeight: 1
						}
					});
					
				}
				
				if (locationType == 'COUNTY') {
					
// 					map.data.addGeoJson(JSON.parse('{\"type\":\"Feature\",\"geometries\":[{\"type\":\"MultiPolygon\",\"coordinates\":[[[[-122.957166000000001,49.002082399999999],[-122.957148000000004,49.009782000000001],[-122.890444000000002,49.062742999999998],[-122.890379999999993,49.091686000000003],[-122.890382000000002,49.092421000000002],[-122.890387000000004,49.098281999999998],[-122.890399000000002,49.104702000000003],[-122.890449000000004,49.111840999999998],[-122.890375000000006,49.119337999999999],[-122.890396800000005,49.119373699999997],[-122.890366,49.126714999999997],[-122.890268399999997,49.131029300000002],[-122.890266100000005,49.1325346],[-122.890266999999994,49.133523199999999],[-122.890266499999996,49.133610099999999],[-122.890355,49.134087000000001],[-122.890257599999998,49.135140499999999],[-122.890254299999995,49.135224100000002],[-122.890248200000002,49.135495800000001],[-122.890353000000005,49.141323],[-122.890358000000006,49.148580000000003],[-122.890361100000007,49.150222499999998],[-122.890361299999995,49.150343900000003],[-122.890361999999996,49.150690900000001],[-122.890362300000007,49.150860600000001],[-122.890371999999999,49.155988000000001],[-122.890359000000004,49.163209999999999],[-122.890292200000005,49.1677204],[-122.890291300000001,49.167786100000001],[-122.890252000000004,49.170437999999997],[-122.890153999999995,49.177145000000003],[-122.901169999999993,49.177126999999999],[-122.912381999999994,49.177112999999999],[-122.915450000000007,49.177104],[-122.922833999999995,49.177081000000001],[-122.914118000000002,49.19256],[-122.911698999999999,49.195732],[-122.899450999999999,49.203198999999998],[-122.895619999999994,49.205958000000003],[-122.884118999999998,49.217632999999999],[-122.877211000000003,49.219779000000003],[-122.8764556,49.219854699999999],[-122.866776999999999,49.220824999999998],[-122.855735999999993,49.220621999999999],[-122.843000000000004,49.219876999999997],[-122.805222599999993,49.220390100000003],[-122.803668999999999,49.220422999999997],[-122.795541999999998,49.216946],[-122.778856000000005,49.214230999999998],[-122.771321999999998,49.213467000000001],[-122.750938199999993,49.215262799999998],[-122.739776000000006,49.213453000000001],[-122.731123199999999,49.211565299999997],[-122.726426000000004,49.201765000000002],[-122.725947300000001,49.1986548],[-122.725424000000004,49.195253999999998],[-122.722722000000005,49.188538999999999],[-122.720453000000006,49.186629000000003],[-122.714271999999994,49.184246000000002],[-122.707606999999996,49.182958999999997],[-122.701307999999997,49.183231999999997],[-122.695611,49.18383],[-122.692201999999995,49.184255],[-122.685551000000004,49.185273000000002],[-122.679473000000002,49.187080000000002],[-122.679475999999994,49.186005000000002],[-122.679490999999999,49.176983999999997],[-122.679306999999994,49.170147999999998],[-122.679108999999997,49.162892999999997],[-122.679278999999994,49.155639999999998],[-122.679444000000004,49.148221999999997],[-122.679501000000002,49.140884999999997],[-122.679563999999999,49.133606],[-122.679829999999995,49.119075000000002],[-122.679885900000002,49.113785900000003],[-122.679903999999993,49.111699000000002],[-122.679917799999998,49.109763899999997],[-122.679956000000004,49.104399000000001],[-122.679865000000007,49.100270999999999],[-122.679807999999994,49.0976882],[-122.679794999999999,49.097101000000002],[-122.679751300000007,49.094900500000001],[-122.679719000000006,49.093279000000003],[-122.679671999999997,49.0914],[-122.679647000000003,49.090522999999997],[-122.679698000000002,49.089669000000001],[-122.679704999999998,49.089579000000001],[-122.679760000000002,49.088693999999997],[-122.679816000000002,49.087780000000002],[-122.679873000000001,49.086866000000001],[-122.679928000000004,49.085959000000003],[-122.679985000000002,49.084077999999998],[-122.679989800000001,49.083993900000003],[-122.680097000000004,49.082126000000002],[-122.680117199999998,49.081739499999998],[-122.680177999999998,49.080573000000001],[-122.680273,49.078570999999997],[-122.680319999999995,49.077688000000002],[-122.680521999999996,49.074700999999997],[-122.680515999999997,49.071691999999999],[-122.680622999999997,49.071593999999997],[-122.680623999999995,49.069310999999999],[-122.680625000000006,49.067590000000003],[-122.680625000000006,49.067481999999998],[-122.680617999999996,49.062198000000002],[-122.680615000000003,49.060211000000002],[-122.680520999999999,49.060116000000001],[-122.680488999999994,49.052891000000002],[-122.680389000000005,49.045650000000002],[-122.680333000000005,49.042152000000002],[-122.680400000000006,49.038471000000001],[-122.680350000000004,49.031185000000001],[-122.680349000000007,49.031095000000001],[-122.680143999999999,49.023927],[-122.6800997,49.0227869],[-122.6799575,49.019123100000002],[-122.679858999999993,49.016587000000001],[-122.680014999999997,49.009278999999999],[-122.680137999999999,49.0021232],[-122.691124299999998,49.002117499999997],[-122.713991800000002,49.002103599999998],[-122.7305001,49.002093600000002],[-122.735095099999995,49.002093299999999],[-122.735427999999999,49.002093199999997],[-122.735706100000002,49.002093199999997],[-122.735865000000004,49.002093100000003],[-122.736073700000006,49.002093100000003],[-122.755304499999994,49.002086400000003],[-122.755890699999995,49.002086400000003],[-122.755966099999995,49.002086200000001],[-122.756079499999998,49.002086400000003],[-122.756946499999998,49.002086400000003],[-122.7571382,49.002086400000003],[-122.757261499999998,49.002086400000003],[-122.757910499999994,49.002086300000002],[-122.786947400000003,49.002076700000003],[-122.790301999999997,49.002085700000002],[-122.790241499999993,49.016476300000001],[-122.790241100000003,49.016573100000002],[-122.790240999999995,49.016607],[-122.779259999999994,49.016581000000002],[-122.779254800000004,49.017697400000003],[-122.779193000000006,49.031059999999997],[-122.845419000000007,49.031224999999999],[-122.845441300000005,49.027898999999998],[-122.845443599999996,49.027545500000002],[-122.845444999999998,49.026544999999999],[-122.845580999999996,49.002084600000003],[-122.957166000000001,49.002082399999999]]]]}]}'));
					
					readTextFile("countyLocationOsmMapping.json", function(text){
						var mapping = JSON.parse(text);
						for (var locationList of locations) {
							for (var location of locationList) {
								if (location in mapping) {
									readTextFile("usCountyGeoJsonData/" + mapping[location] + ".txt", function(geoJsonText){
										var geoJsonData = JSON.parse(geoJsonText);
										geoJsonData.type = 'Feature';
										geoJsonData.geometry = geoJsonData.geometries[0];
										delete geoJsonData.geometries;
										geoJsonData.properties = {"osmid": mapping[location]};
										console.log(JSON.stringify(geoJsonData));
										map.data.addGeoJson(geoJsonData);
									});
// 									map.data.loadGeoJson('http://polygons.openstreetmap.fr/get_geojson.py?id=' + mapping[location] + '&params=0');
								} else {
									console.log('location ' + location + ' not found.');
								}
							}
						}
					});
					
				}
				
			}
			
		</script>
		
	</body>

</html>
