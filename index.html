<!DOCTYPE html>
<html>

	<head>
		
		<title>Geo Example</title>
		
		<style>
			
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			
			#map {
				height: 100%;
			}
			
		</style>
		
	</head>

	<body>

		<div id="map"></div>
		
		<script>
			
			var urlParams = new URLSearchParams(window.location.search);
			var JSElement = document.createElement('script');
			JSElement.src = "https://maps.googleapis.com/maps/api/js?key=" + urlParams.get('token');// + "&callback=initMap";
			JSElement.defer = true;
			JSElement.onload = initMap;
			document.getElementsByTagName('head')[0].appendChild(JSElement);
			
			function readTextFile(file, callback) {
				var rawFile = new XMLHttpRequest();
				rawFile.overrideMimeType("application/json");
				rawFile.open("GET", file, true);
				rawFile.onreadystatechange = function() {
					if (rawFile.readyState === 4 && rawFile.status == "200") {
						callback(rawFile.responseText);
					}
				}
				rawFile.send(null);
			}
			
			function initMap() {
				
				var map = new google.maps.Map(document.getElementById('map'), {
					zoom: 4,
					center: {lng: -98.5556199, lat: 39.8097343},
					mapTypeId: 'terrain'
				});
				
// 				var locationType = 'DMA';
// 				var locations = [
// 					[662, 790, 634, 635, 537, 821, 502, 757, 514, 767, 519, 584, 602, 598, 546, 535, 623, 751, 606, 565, 802, 513, 670, 798, 755, 545, 636, 533, 618, 527, 561, 603, 702, 643, 839, 722, 529, 669, 813, 528, 687, 628, 570, 501, 633, 534, 804, 675, 508, 552, 560, 556, 611, 576, 641, 855, 657, 725, 619, 609, 539, 605, 789, 709, 625, 705, 627, 550, 771],	// cell 1
// 					[525, 644, 524, 800, 716, 756, 630, 506, 523, 637, 564, 575, 868, 510, 604, 673, 682, 679, 676, 516, 649, 866, 509, 773, 658, 567, 566, 710, 691, 718, 574, 616, 582, 551, 541, 693, 651, 737, 640, 617, 762, 828, 659, 544, 650, 631, 656, 504, 820, 521, 764, 573, 610, 770, 825, 507, 612, 588, 543, 555, 581, 540, 671, 526, 511, 548, 678, 810, 596],	// cell 2
// 					[532, 583, 520, 512, 692, 746, 559, 736, 754, 648, 517, 759, 515, 752, 522, 600, 542, 505, 765, 801, 724, 571, 592, 563, 518, 647, 569, 766, 758, 639, 734, 557, 642, 749, 558, 803, 503, 553, 711, 613, 686, 698, 622, 740, 652, 632, 597, 753, 500, 717, 811, 538, 862, 661, 807, 819, 624, 881, 638, 530, 547, 531, 760, 626, 549, 554, 577, 536]		// cell 3
// 				];
				
				var locationType = 'COUNTY';
				var locations = [
					[943, 951, 959],	// cell 1
					[967, 975, 983],	// cell 2
					[991, 999, 1007, 1015]	// cell 3
				];
				
				
				if (locationType == 'DMA') {

					readTextFile("dmaData.json", function(text){
						var dmaData = JSON.parse(text);
						for (var locationList of locations) {
							for (var location of locationList) {
								var geoData = dmaData.features.filter(function(data) { 
									return data.properties.dma == location 
								});
								if (geoData.length == 1) {
									map.data.addGeoJson(geoData[0]);
								} else if (geoData.length == 0) {
									console.log('no dmas found for ' + location);
								} else {
									console.log('multiple dmas found for ' + location);
								}

							}
						}
					});

					map.data.setStyle(function(feature) {
						var dma = feature.getProperty('dma');
						var colors = ['red', 'blue', 'green'];
						for (var i = 0; i < locations.length; i++) {
							if (locations[i].includes(dma)) {
								return {
									fillColor: colors[i],
									strokeWeight: 1
								}
							}
						}
						return {
							fillColor: 'gray',
							strokeWeight: 1
						}
					});
					
				}
				
				if (locationType == 'COUNTY') {
					
					readTextFile("countyLocationOsmMapping.json", function(text){
						var mapping = JSON.parse(text);
						for (var locationList of locations) {
							for (var location of locationList) {
								if (location in mapping) {
// 									map.data.loadGeoJson('http://polygons.openstreetmap.fr/get_geojson.py?id=' + mapping[location] + '&params=0');
									fetch('http://polygons.openstreetmap.fr/get_geojson.py?id=' + mapping[location] + '&params=0')
										.then(res => {
											var jsonString = '{\"type\":\"FeatureCollection\",\"features\":[' + JSON.stringify(res) + ']}';
											console.log(jsonString);
											map.data.addGeoJson(JSON.parse(jsonString));
										})
										.catch(err => console.error(err));
								} else {
									console.log('location ' + location + ' not found.');
								}
							}
						}
					});
					
				}
				
			}
			
		</script>
		
	</body>

</html>
